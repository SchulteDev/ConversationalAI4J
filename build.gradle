plugins {
  id 'org.sonarqube' version '6.2.0.5505'
  id 'jacoco'
}

group = 'schultedev'
version = '1.0-SNAPSHOT'

allprojects {
  repositories {
    mavenCentral()
  }
}

// Configure each module individually to avoid conflicts
project(':library') {
  apply plugin: 'java'
  apply plugin: 'jacoco'

  java {
    toolchain {
      languageVersion = JavaLanguageVersion.of(21)
    }
  }

  test {
    useJUnitPlatform()
  }

  jacocoTestReport {
    dependsOn test
    reports {
      xml.required = true
    }
  }
}

// Demo module: NO parent configuration - let Spring Boot handle everything
project(':demo') {
  // Only set Java toolchain, nothing else
  afterEvaluate {
    if (project.plugins.hasPlugin('java')) {
      java {
        toolchain {
          languageVersion = JavaLanguageVersion.of(21)
        }
      }
    }
  }
}

// SonarCloud multi-module configuration
sonar {
  properties {
    property "sonar.projectKey", "SchulteDev_ConversationalAI4J"
    property "sonar.organization", "schultedev"
    property "sonar.host.url", "https://sonarcloud.io"

    // Multi-module configuration - SonarCloud will aggregate the reports
    property "sonar.coverage.jacoco.xmlReportPaths", "**/build/reports/jacoco/test/jacocoTestReport.xml"
    property "sonar.junit.reportPaths", "**/build/test-results/test"
  }
}

// =============================================================================
// Developer Experience Tasks
// =============================================================================

task dockerStart(type: Exec) {
  group = 'development'
  description = 'Start Docker environment with auto-rebuild'
  
  commandLine 'docker-compose', 'up', '--build'
  
  doFirst {
    println 'ğŸš€ Starting development environment...'
    println 'Demo will be available at: http://localhost:8080'
  }
}

task dockerLogs(type: Exec) {
  group = 'development' 
  description = 'Show Docker container logs'
  
  commandLine 'docker-compose', 'logs', '-f'
  
  doFirst {
    println 'ğŸ“‹ Showing Docker logs...'
  }
}

task dockerReset(type: Exec) {
  group = 'development'
  description = 'Reset Docker environment (useful when containers fail)'
  
  commandLine 'sh', '-c', 'docker-compose down && docker system prune -f && docker-compose up --build'
  
  doFirst {
    println 'ğŸ”„ Resetting Docker environment...'
  }
}

task dockerStop(type: Exec) {
  group = 'development'
  description = 'Stop Docker environment'
  
  commandLine 'docker-compose', 'down'
  
  doFirst {
    println 'ğŸ›‘ Stopping Docker environment...'
  }
}

task dev {
  group = 'development'
  description = 'Start demo in development mode with hot reload'
  
  dependsOn ':demo:bootRun'
  
  doFirst {
    println 'ğŸ’» Starting demo in development mode...'
    println 'Demo will be available at: http://localhost:8080'
    println 'Hot reload enabled - modify files and refresh!'
  }
}

task testAll {
  group = 'verification'
  description = 'Run all tests with summary'
  
  dependsOn ':library:test', ':demo:test'
  
  doLast {
    println 'ğŸ§ª All tests completed!'
    println "Library tests: ./gradlew :library:test"
    println "Demo tests: ./gradlew :demo:test" 
  }
}

task cleanBuild {
  group = 'build'
  description = 'Clean build all modules'
  
  dependsOn 'clean', 'build'
  
  doFirst {
    println 'ğŸ§¹ Clean building all modules...'
  }
  
  doLast {
    println 'âœ… Clean build completed!'
  }
}

task devHelp {
  group = 'help'
  description = 'Show developer commands'
  
  doLast {
    println '''
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                ConversationalAI4J Developer Tasks            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Quick Start:                                                 â•‘
â•‘   ./gradlew dockerStart    - Start Docker environment        â•‘
â•‘   ./gradlew dev           - Development mode (hot reload)    â•‘
â•‘                                                              â•‘
â•‘ Testing:                                                     â•‘
â•‘   ./gradlew testAll       - Run all tests                    â•‘
â•‘   ./gradlew cleanBuild    - Clean build                      â•‘
â•‘                                                              â•‘
â•‘ Docker Management:                                           â•‘
â•‘   ./gradlew dockerLogs    - Show container logs              â•‘
â•‘   ./gradlew dockerReset   - Reset when things break         â•‘
â•‘   ./gradlew dockerStop    - Stop containers                  â•‘
â•‘                                                              â•‘
â•‘ Module-Specific:                                             â•‘
â•‘   ./gradlew :library:test - Test library only               â•‘
â•‘   ./gradlew :demo:test    - Test demo only                   â•‘
â•‘   ./gradlew :demo:bootRun - Run demo (alternative to dev)   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ Recommended workflow:
   1. ./gradlew dockerStart     (for full system with Ollama)
   2. ./gradlew dev            (for fast development iteration)
   3. ./gradlew testAll        (before committing changes)
'''
  }
}
